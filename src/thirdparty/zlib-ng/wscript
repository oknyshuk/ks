#! /usr/bin/env python

def options(opt):
    return

def configure(conf):
    return

def build(bld):
    # Core sources
    core_sources = [
        'adler32.c',
        'compress.c',
        'cpu_features.c',
        'crc32.c',
        'crc32_braid_comb.c',
        'deflate.c',
        'deflate_fast.c',
        'deflate_huff.c',
        'deflate_medium.c',
        'deflate_quick.c',
        'deflate_rle.c',
        'deflate_slow.c',
        'deflate_stored.c',
        'functable.c',
        'gzlib.c',
        'gzread.c',
        'gzwrite.c',
        'infback.c',
        'inflate.c',
        'inftrees.c',
        'insert_string.c',
        'insert_string_roll.c',
        'trees.c',
        'uncompr.c',
        'zutil.c',
    ]

    # Generic fallback sources (needed for non-SIMD paths)
    generic_sources = [
        'arch/generic/adler32_c.c',
        'arch/generic/adler32_fold_c.c',
        'arch/generic/chunkset_c.c',
        'arch/generic/compare256_c.c',
        'arch/generic/crc32_braid_c.c',
        'arch/generic/crc32_fold_c.c',
        'arch/generic/slide_hash_c.c',
    ]

    # x86_64 specific sources
    x86_sources = [
        'arch/x86/x86_features.c',
    ]

    base_defines = [
        'ZLIB_COMPAT',
        'HAVE_ATTRIBUTE_ALIGNED',
        'HAVE_BUILTIN_CTZ',
        'HAVE_BUILTIN_CTZLL',
        'HAVE_VISIBILITY_HIDDEN',
        'HAVE_BUILTIN_ASSUME_ALIGNED',
        'WITH_GZFILEOP',
        'HAVE_UNISTD_H',
    ]

    includes = ['.', 'arch/x86']

    if bld.env.DEST_OS == 'win32':
        # Windows: just use generic sources
        bld.stlib(
            source   = core_sources + generic_sources,
            target   = 'zlib',
            features = 'c',
            includes = includes,
            defines  = base_defines,
            subsystem = bld.env.MSVC_SUBSYSTEM,
            idx = bld.get_taskgen_count()
        )
        return

    # Linux/POSIX with x86_64 SIMD
    x86_defines = base_defines + [
        'X86_FEATURES',
        'X86_SSE2',
        'X86_SSSE3',
        'X86_SSE41',
        'X86_SSE42',
        'X86_PCLMULQDQ',
        'X86_AVX2',
        'X86_AVX512',
        'X86_AVX512VNNI',
        'X86_VPCLMULQDQ',
    ]

    # Build core + generic + x86 base
    bld.objects(
        source   = core_sources + generic_sources + x86_sources,
        target   = 'zlib_core',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        idx = bld.get_taskgen_count()
    )

    # SSE2 sources
    bld.objects(
        source   = [
            'arch/x86/chunkset_sse2.c',
            'arch/x86/chorba_sse2.c',
            'arch/x86/compare256_sse2.c',
            'arch/x86/slide_hash_sse2.c',
        ],
        target   = 'zlib_sse2',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-msse2'],
        idx = bld.get_taskgen_count()
    )

    # SSSE3 sources
    bld.objects(
        source   = [
            'arch/x86/adler32_ssse3.c',
            'arch/x86/chunkset_ssse3.c',
        ],
        target   = 'zlib_ssse3',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-mssse3'],
        idx = bld.get_taskgen_count()
    )

    # SSE4.1 sources
    bld.objects(
        source   = ['arch/x86/chorba_sse41.c'],
        target   = 'zlib_sse41',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-msse4.1'],
        idx = bld.get_taskgen_count()
    )

    # SSE4.2 sources
    bld.objects(
        source   = ['arch/x86/adler32_sse42.c'],
        target   = 'zlib_sse42',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-msse4.2'],
        idx = bld.get_taskgen_count()
    )

    # PCLMUL sources
    bld.objects(
        source   = ['arch/x86/crc32_pclmulqdq.c'],
        target   = 'zlib_pclmul',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-mpclmul', '-msse4.2'],
        idx = bld.get_taskgen_count()
    )

    # AVX2 sources
    bld.objects(
        source   = [
            'arch/x86/adler32_avx2.c',
            'arch/x86/chunkset_avx2.c',
            'arch/x86/compare256_avx2.c',
            'arch/x86/slide_hash_avx2.c',
        ],
        target   = 'zlib_avx2',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-mavx2'],
        idx = bld.get_taskgen_count()
    )

    # AVX512 sources
    bld.objects(
        source   = [
            'arch/x86/adler32_avx512.c',
            'arch/x86/adler32_avx512_vnni.c',
            'arch/x86/chunkset_avx512.c',
            'arch/x86/compare256_avx512.c',
        ],
        target   = 'zlib_avx512',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-mavx512f', '-mavx512dq', '-mavx512bw', '-mavx512vl'],
        idx = bld.get_taskgen_count()
    )

    # VPCLMUL sources
    bld.objects(
        source   = ['arch/x86/crc32_vpclmulqdq.c'],
        target   = 'zlib_vpclmul',
        features = 'c',
        includes = includes,
        defines  = x86_defines,
        cflags   = ['-mvpclmulqdq', '-mavx512f'],
        idx = bld.get_taskgen_count()
    )

    # Final library linking all objects
    bld.stlib(
        source   = [],
        target   = 'zlib',
        features = 'c',
        use      = ['zlib_core', 'zlib_sse2', 'zlib_ssse3', 'zlib_sse41',
                    'zlib_sse42', 'zlib_pclmul', 'zlib_avx2', 'zlib_avx512',
                    'zlib_vpclmul'],
        idx = bld.get_taskgen_count()
    )
