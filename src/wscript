#! /usr/bin/env python
# a1batross, mittorn, nn-firc

import os
import shutil

from waflib import Configure, Context, TaskGen


@TaskGen.feature("cxxprogram", "cprogram", "cxxshlib", "cshlib")
@TaskGen.after_method("apply_link")
def add_rpath_for_install(self):
    """Automatically add RPATH based on install_path so libraries find each other."""
    if self.env.DEST_OS == "win32":
        return

    install_path = getattr(self, "install_path", None)
    if not install_path:
        return

    # Don't override if rpath is explicitly set
    if getattr(self, "rpath", None):
        return

    # Determine RPATH based on install location
    prefix = self.env.PREFIX
    binpath = self.env.BINPATH
    gamebin = self.env.GAMEBIN

    rpath = []
    if install_path == prefix:
        # Executable in game/ - needs bin/ and csgo/bin/
        rpath = ["$ORIGIN/bin", "$ORIGIN/csgo/bin"]
    elif install_path == binpath:
        # Library in game/bin/ - needs to find other libs in same dir
        rpath = ["$ORIGIN"]
    elif install_path == gamebin:
        # Library in game/csgo/bin/ - needs bin/ and same dir
        rpath = ["$ORIGIN", "$ORIGIN/../../bin"]

    if rpath:
        self.env.append_unique("RPATH", rpath)


VERSION = "0.01"
APPNAME = "CSGO"
top = "."
default_prefix = os.path.abspath("../game")

Context.Context.line_just = 60  # should fit for everything on 80x26

PROJECTS = [
    "appframework",
    "bitmap",
    "bonesetup",
    "choreoobjects",
    "d3dx",
    "datacache",
    "dmxloader",
    "engine",
    "engine/voice_codecs/celt",
    "filesystem",
    "game/client",
    "game/server",
    "gcsdk",
    "generated_proto",
    "inputsystem",
    "interfaces",
    "launcher",
    "launcher_main",
    "localize",
    "matchmaking",
    "materialsystem",
    "materialsystem/shaderapidx9",
    "materialsystem/shaderlib",
    "materialsystem/stdshaders",
    "mathlib",
    "particles",
    "raytrace",
    "resourcefile",
    "responserules/runtime",
    "scenefilecache",
    "serverbrowser",
    "soundemittersystem",
    "soundsystem/lowlevel",
    "studiorender",
    "thirdparty/celt-v0.11.3",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/d3d9",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/dxso",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/dxvk",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/spirv",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/util",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/vulkan",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/wsi",
    "thirdparty/JoltPhysics-4.0.2/Jolt",
    "thirdparty/jpeg-8",
    "thirdparty/libpng-1.5.2",
    "thirdparty/mojoAL",
    "thirdparty/protobuf-2.6.1/src",
    "thirdparty/quickhull",
    "thirdparty/zlib-ng",
    "tier0",
    "tier1",
    "tier2",
    "tier3",
    "utils/bzip2",
    "vgui2/matsys_controls",
    "vgui2/src",
    "vgui2/vgui_controls",
    "vgui2/vgui_surfacelib",
    "vguimatsurface",
    "videocfg",
    "vphysics",
    "vpklib",
    "vscript",
    "vstdlib",
    "vtf",
]


@Configure.conf
def get_taskgen_count(self):
    try:
        idx = self.tg_idx_count
    except:
        idx = 0  # don't set tg_idx_count to not increase counter
    return idx


def options(opt):
    opt.load(
        "reconfigure compiler_optimizations compiler_c compiler_cxx ndk clang_compilation_database strip_on_install msdev msvs msvc subproject ccache"
    )

    grp = opt.add_option_group("Common options")

    grp.add_option(
        "-w",
        "--no-warnings",
        action="store_true",
        dest="NO_WARNINGS",
        default=False,
        help="disable warnings",
    )
    grp.add_option(
        "--dedicated",
        action="store_true",
        dest="DEDICATED",
        default=False,
        help="build dedicated server",
    )

    opt.add_subproject(PROJECTS)


def configure(conf):
    conf.load("fwgslib reconfigure ndk compiler_optimizations")
    conf.env.MSVC_TARGETS = ["x64"]
    conf.env.MSVC_SUBSYSTEM = "WINDOWS"
    conf.env.DEDICATED = conf.options.DEDICATED

    if conf.env.DEST_OS == "android":
        conf.env.BINPATH = conf.env.GAMEBIN = conf.env.PREFIX + "/lib"
    else:
        conf.env.BINPATH = conf.env.PREFIX + "/bin"
        conf.env.GAMEBIN = conf.env.PREFIX + "/csgo/bin"

    # Load compilers early
    conf.load("compiler_c compiler_cxx ndk")

    # Auto-enable ccache if available
    if not conf.options.CCACHE and shutil.which("ccache"):
        conf.options.CCACHE = True
    conf.load("ccache")

    # Configure ccache for optimal performance (per-project config)
    if conf.options.CCACHE:
        base_dir = conf.srcnode.abspath()
        ccache_conf_path = conf.srcnode.make_node("ccache.conf").abspath()
        ccache_config = {
            "base_dir": base_dir,
            "sloppiness": "include_file_mtime,include_file_ctime,time_macros,pch_defines,file_stat_matches,clang_index_store,locale,random_seed",
            "hash_dir": "false",
            "max_size": "30G",
            "hard_link": "true",
            "compression_level": "1",
            "depend_mode": "true",
            "inode_cache": "true",
        }
        with open(ccache_conf_path, "w") as f:
            for key, val in ccache_config.items():
                f.write(f"{key} = {val}\n")
        os.environ["CCACHE_CONFIGPATH"] = ccache_conf_path
        os.environ["CCACHE_BASEDIR"] = base_dir

    # HACKHACK: override msvc DEST_CPU value by something that we understand
    if conf.env.DEST_CPU == "amd64":
        conf.env.DEST_CPU = "x86_64"

    if conf.env.COMPILER_CC == "msvc":
        conf.load("msvc_pdb")

    conf.load(
        "msvs msdev subproject clang_compilation_database strip_on_install enforce_pic"
    )

    enforce_pic = True  # modern defaults
    conf.check_pic(enforce_pic)

    cflags, linkflags = conf.get_optimization_flags()
    cxxflags = list(
        cflags
    )  # optimization flags are common between C and C++ but we need a copy

    if conf.env.COMPILER_CC in ["gcc", "clang"]:
        conf.env.append_unique("CFLAGS_cshlib", ["-fPIC"])
        conf.env.append_unique("CXXFLAGS_cxxshlib", ["-fPIC"])
        # Generate dependency files for ccache depend_mode
        conf.env.append_unique("CFLAGS", ["-MD"])
        conf.env.append_unique("CXXFLAGS", ["-MD"])

    conf.check_cc(
        cflags=cflags, linkflags=linkflags, msg="Checking for required C flags"
    )
    conf.check_cxx(
        cxxflags=cxxflags, linkflags=linkflags, msg="Checking for required C++ flags"
    )

    conf.env.append_unique("CFLAGS", cflags)
    conf.env.append_unique("CXXFLAGS", cxxflags)
    conf.env.append_unique("LINKFLAGS", linkflags)

    opt_flags = []
    opt_cflags = []
    opt_cxxflags = []

    if conf.options.NO_WARNINGS and conf.env.COMPILER_CC in ["gcc", "clang"]:
        opt_flags += ["-w"]

    if conf.env.COMPILER_CC == "clang":
        opt_flags += ["-fcolor-diagnostics"]
    elif conf.env.COMPILER_CC == "gcc":
        opt_flags += ["-fdiagnostics-color=always"]

    # Use mold linker for faster link times (if available)
    if conf.env.DEST_OS != "win32" and shutil.which("mold"):
        conf.env.append_unique("LINKFLAGS", ["-fuse-ld=mold"])

    if conf.env.COMPILER_CC == "msvc":
        opt_cxxflags += ["/std:c++20"]
    elif conf.env.COMPILER_CC in ["gcc", "clang"]:
        opt_cxxflags += ["-std=c++20"]

    cflags = conf.filter_cflags(opt_flags + opt_cflags, cflags)
    cxxflags = conf.filter_cxxflags(opt_flags + opt_cxxflags, cxxflags)

    conf.env.append_unique("CFLAGS", cflags)
    conf.env.append_unique("CXXFLAGS", cxxflags)

    # Add flags that shouldn't go through filter_cxxflags (which tests with -Werror)
    if conf.env.COMPILER_CC in ["gcc", "clang"]:
        # Suppress offsetof warning for non-standard-layout types (Source Engine uses this extensively)
        conf.env.append_unique("CXXFLAGS", ["-Wno-invalid-offsetof"])
        # Suppress false positive from GCC inlining protobuf code (FunctionClosure0 with self_deleting=false)
        conf.env.append_unique("CXXFLAGS", ["-Wno-free-nonheap-object"])

    includes = [
        os.path.abspath("public"),
        os.path.abspath("public/tier0"),
        os.path.abspath("public/tier1"),
        os.path.abspath("common"),
    ]

    if conf.env.COMPILER_CC == "msvc":
        conf.define("COMPILER_MSVC", True)
        conf.define("_CRT_SECURE_NO_WARNINGS", True)
        conf.define("COMPILER_MSVC64", True)
    elif conf.env.COMPILER_CC in ["gcc", "clang"]:
        conf.define("COMPILER_GCC", True)

    if conf.env.DEST_OS == "win32":  # TODO: IMPLETE ME!
        conf.define("_WIN32", True)
        conf.define("_DLL_EXT", ".dll", quote=False)
    else:
        conf.define("_POSIX", True)
        conf.define("POSIX", True)
        conf.define("USE_SDL", True)
        if conf.env.DEST_OS == "linux":
            conf.define("_LINUX", True)
            conf.define("LINUX", True)
            conf.define("GNUC", True)
            conf.define("_DLL_EXT", ".so", quote=False)
        conf.check_cfg(package="sdl2", args="--cflags --libs", uselib_store="SDL2")
        includes += conf.env.INCLUDES_SDL2
        conf.check_cfg(package="freetype2", args="--cflags --libs", uselib_store="FREETYPE")
        includes += conf.env.INCLUDES_FREETYPE
        conf.check_cfg(package="fontconfig", args="--cflags --libs", uselib_store="FONTCONFIG")
        includes += conf.env.INCLUDES_FONTCONFIG

    conf.define("CSTRIKE15", True)
    conf.define("CSTRIKE_REL_BUILD", True)
    conf.define("VPROF_LEVEL", True)
    conf.define("RAD_TELEMETRY_DISABLED", True)

    if conf.env.DEST_OS != "win32":
        conf.define("DX_TO_VK_ABSTRACTION", True)
        includes += [
            os.path.abspath("thirdparty/dxvk-native-2.7.1-4bbe487/include/native/windows"),
            os.path.abspath("thirdparty/dxvk-native-2.7.1-4bbe487/include/native/directx"),
        ]
    else:
        conf.define("USE_ACTUAL_DX", True)

    if conf.options.BUILD_TYPE == "debug":
        conf.define("DEBUG", 1)
        conf.define("_DEBUG", 1)
    else:
        conf.define("NDEBUG", 1)

    conf.define("PLATFORM_64BITS", True)

    if conf.env.DEDICATED:
        conf.define("DEDICATED", True)

    conf.env.append_unique("INCLUDES", includes)

    # Mark thirdparty headers as system includes to suppress warnings
    for sysinc in ["thirdparty/protobuf-2.6.1/src"]:
        conf.env.append_unique("CFLAGS", ["-isystem", os.path.abspath(sysinc)])
        conf.env.append_unique("CXXFLAGS", ["-isystem", os.path.abspath(sysinc)])

    # Optimize for the current CPU
    if conf.env.DEST_OS != "win32":
        conf.env.append_unique("CFLAGS", ["-march=native"])
        conf.env.append_unique("CXXFLAGS", ["-march=native"])

    conf.add_subproject(PROJECTS)


def build(bld):
    # Set per-project ccache config path and base directory
    base_dir = bld.srcnode.abspath()
    ccache_conf_path = bld.srcnode.make_node("ccache.conf").abspath()
    if os.path.exists(ccache_conf_path):
        os.environ["CCACHE_CONFIGPATH"] = ccache_conf_path
        os.environ["CCACHE_BASEDIR"] = base_dir
    bld.add_subproject(PROJECTS)
