#! /usr/bin/env python

import os
import shutil

from waflib import Build, Configure, Context, TaskGen

# --- Auto-RPATH based on install location ---


@TaskGen.feature("cxxprogram", "cprogram", "cxxshlib", "cshlib")
@TaskGen.after_method("apply_link")
def add_rpath_for_install(self):
    install_path = getattr(self, "install_path", None)
    if not install_path or getattr(self, "rpath", None):
        return

    prefix = self.env.PREFIX
    binpath = self.env.BINPATH
    gamebin = self.env.GAMEBIN

    rpath = []
    if install_path == prefix:
        rpath = ["$ORIGIN/bin", "$ORIGIN/csgo/bin"]
    elif install_path == binpath:
        rpath = ["$ORIGIN"]
    elif install_path == gamebin:
        rpath = ["$ORIGIN", "$ORIGIN/../../bin"]

    if rpath:
        self.env.append_unique("RPATH", rpath)


# --- Project metadata ---

VERSION = "0.01"
APPNAME = "CSGO"
top = "."
default_prefix = os.path.abspath("../game")

Context.Context.line_just = 60

PROJECTS = [
    "appframework",
    "bitmap",
    "bonesetup",
    "choreoobjects",
    "d3dx",
    "datacache",
    "dmxloader",
    "engine",
    "engine/voice_codecs/celt",
    "filesystem",
    "game/client",
    "game/server",
    "generated_proto",
    "inputsystem",
    "interfaces",
    "launcher",
    "launcher_main",
    "localize",
    "matchmaking",
    "materialsystem",
    "materialsystem/shaderapidx9",
    "materialsystem/shaderlib",
    "materialsystem/stdshaders",
    "mathlib",
    "particles",
    "raytrace",
    "resourcefile",
    "rocketui",
    "responserules/runtime",
    "scenefilecache",
    "serverbrowser",
    "soundemittersystem",
    "soundsystem/lowlevel",
    "studiorender",
    "thirdparty/celt-v0.11.3",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/d3d9",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/dxso",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/dxvk",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/spirv",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/util",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/vulkan",
    "thirdparty/dxvk-native-2.7.1-4bbe487/src/wsi",
    "thirdparty/JoltPhysics-4.0.2/Jolt",
    "thirdparty/mojoAL",
    "thirdparty/protobuf-2.6.1/src",
    "thirdparty/quickhull",
    "thirdparty/RmlUi",
    "tier0",
    "tier1",
    "tier2",
    "tier3",
    "utils/bzip2",
    "vgui2/matsys_controls",
    "vgui2/src",
    "vgui2/vgui_controls",
    "vgui2/vgui_surfacelib",
    "vguimatsurface",
    "videocfg",
    "vphysics",
    "vpklib",
    "vscript",
    "vstdlib",
    "vtf",
]


# --- Build ordering helper (used by all subprojects via idx=) ---


def _get_taskgen_count(self):
    try:
        idx = self.tg_idx_count
    except AttributeError:
        idx = 0
    return idx


Configure.ConfigurationContext.get_taskgen_count = _get_taskgen_count
Build.BuildContext.get_taskgen_count = _get_taskgen_count


# --- Optimization flag tables ---

OPTFLAGS = {
    "fast": {
        "gcc": [
            "-Ofast",
            "-funsafe-math-optimizations",
            "-fomit-frame-pointer",
            "-fno-semantic-interposition",
        ],
        "clang": ["-O3", "-ffast-math"],
    },
    "release": {
        "gcc": ["-O3", "-fno-semantic-interposition"],
        "clang": ["-O3"],
    },
    "debug": {
        "gcc": ["-O0"],
        "clang": ["-O0"],
    },
    "sanitize": {
        "gcc": ["-O0", "-fsanitize=address", "-pthread"],
        "clang": ["-O0", "-fsanitize=address", "-pthread"],
    },
}


def _filter_cflags(conf, flags, existing=[]):
    supported = []
    for f in flags:
        try:
            conf.check_cc(cflags=["-Werror", f] + existing, mandatory=True)
            supported.append(f)
        except Exception:
            pass
    return supported


def _filter_cxxflags(conf, flags, existing=[]):
    supported = []
    for f in flags:
        try:
            conf.check_cxx(cxxflags=["-Werror", f] + existing, mandatory=True)
            supported.append(f)
        except Exception:
            pass
    return supported


# --- WAF entry points ---


def options(opt):
    opt.load("compiler_c compiler_cxx clang_compilation_database pch unity")

    grp = opt.add_option_group("Common options")

    grp.add_option(
        "-T",
        "--build-type",
        action="store",
        dest="BUILD_TYPE",
        default="fast",
        help="build type: fast, release, debug, sanitize",
    )
    grp.add_option(
        "-w",
        "--no-warnings",
        action="store_true",
        dest="NO_WARNINGS",
        default=False,
        help="disable warnings",
    )
    grp.add_option(
        "--dedicated",
        action="store_true",
        dest="DEDICATED",
        default=False,
        help="build dedicated server",
    )

    opt.recurse(PROJECTS)


def configure(conf):
    conf.env.BINPATH = conf.env.PREFIX + "/bin"
    conf.env.GAMEBIN = conf.env.PREFIX + "/csgo/bin"

    # --- Compiler detection ---
    conf.load("compiler_c compiler_cxx")

    if conf.env.DEST_CPU == "amd64":
        conf.env.DEST_CPU = "x86_64"

    # --- CCache (auto-enable if on PATH) ---
    ccache_path = shutil.which("ccache")
    if ccache_path:
        conf.env.CC = [ccache_path] + conf.env.CC
        conf.env.CXX = [ccache_path] + conf.env.CXX
        conf.msg("CCache", "enabled")

        base_dir = conf.srcnode.abspath()
        ccache_conf_path = conf.srcnode.make_node("ccache.conf").abspath()
        with open(ccache_conf_path, "w") as f:
            for k, v in {
                "base_dir": base_dir,
                "sloppiness": "include_file_mtime,include_file_ctime,time_macros,pch_defines,file_stat_matches,clang_index_store,locale,random_seed",
                "hash_dir": "false",
                "max_size": "30G",
                "hard_link": "true",
                "compression_level": "1",
                "depend_mode": "true",
                "inode_cache": "true",
            }.items():
                f.write(f"{k} = {v}\n")
        os.environ["CCACHE_CONFIGPATH"] = ccache_conf_path
        os.environ["CCACHE_BASEDIR"] = base_dir

    conf.load("clang_compilation_database")
    conf.load("pch")
    if conf.env.WITH_PCH and conf.env.COMPILER_CXX == "clang++":
        conf.env.append_unique("CXXPCH_FLAGS", ["-fpch-instantiate-templates"])
        conf.env.append_unique("CXXPCH_FLAGS", ["-Xclang", "-fno-pch-timestamp"])

    # --- PIC for all code ---
    for var in [
        "CFLAGS_cshlib",
        "CXXFLAGS_cxxshlib",
        "CFLAGS_cstlib",
        "CXXFLAGS_cxxstlib",
    ]:
        conf.env.append_unique(var, ["-fPIC"])

    # --- Optimization flags ---
    build_type = conf.options.BUILD_TYPE
    if build_type not in OPTFLAGS:
        conf.fatal(f"Invalid build type '{build_type}'. Valid: {', '.join(OPTFLAGS)}")
    conf.msg("Build type", build_type)

    compiler = conf.env.COMPILER_CC

    cflags = ["-g", "-fvisibility=hidden"]
    if compiler == "clang":
        cflags += ["-gsplit-dwarf", "-fno-standalone-debug", "-fno-threadsafe-statics"]
    cflags += OPTFLAGS[build_type].get(compiler, OPTFLAGS[build_type].get("gcc", []))
    cxxflags = list(cflags)

    linkflags = []
    if shutil.which("mold"):
        linkflags.append("-fuse-ld=mold")
    if compiler == "clang":
        linkflags.append("-gsplit-dwarf")
    if build_type == "fast" and compiler == "clang":
        cflags.append("-flto=thin")
        cxxflags.append("-flto=thin")
        linkflags.append("-flto=thin")
    if build_type == "sanitize":
        linkflags += ["-fsanitize=address", "-pthread"]

    conf.check_cc(
        cflags=cflags, linkflags=linkflags, msg="Checking for required C flags"
    )
    conf.check_cxx(
        cxxflags=cxxflags, linkflags=linkflags, msg="Checking for required C++ flags"
    )

    conf.env.append_unique("CFLAGS", cflags)
    conf.env.append_unique("CXXFLAGS", cxxflags)
    conf.env.append_unique("LINKFLAGS", linkflags)

    # --- Optional flags (filtered for compiler support) ---
    opt_flags = []
    if conf.options.NO_WARNINGS:
        opt_flags.append("-w")
    if compiler == "clang":
        opt_flags.append("-fcolor-diagnostics")
    elif compiler == "gcc":
        opt_flags.append("-fdiagnostics-color=always")

    conf.env.append_unique("CFLAGS", _filter_cflags(conf, opt_flags, cflags))
    conf.env.append_unique(
        "CXXFLAGS", _filter_cxxflags(conf, opt_flags + ["-std=c++20"], cxxflags)
    )

    # Flags that shouldn't go through filter (which uses -Werror)
    conf.env.append_unique(
        "CXXFLAGS", ["-Wno-invalid-offsetof", "-Wno-free-nonheap-object"]
    )
    # Source Engine was written for MSVC which permits narrowing in brace init
    conf.env.append_unique("CFLAGS", ["-Wno-narrowing"])
    conf.env.append_unique("CXXFLAGS", ["-Wno-c++11-narrowing"])
    # Source Engine predates C++11 override keyword
    conf.env.append_unique("CXXFLAGS", ["-Wno-inconsistent-missing-override"])

    # --- Includes ---
    includes = [
        os.path.abspath("public"),
        os.path.abspath("public/tier0"),
        os.path.abspath("public/tier1"),
        os.path.abspath("common"),
    ]

    # --- Defines ---
    if compiler == "clang":
        conf.define("COMPILER_CLANG", True)
    conf.define("COMPILER_GCC", True)  # GCC-compatible (both gcc and clang)
    conf.define("_POSIX", True)
    conf.define("POSIX", True)
    conf.define("USE_SDL", True)
    conf.define("_LINUX", True)
    conf.define("LINUX", True)
    conf.define("GNUC", True)
    conf.define("_DLL_EXT", ".so", quote=False)
    conf.define("CSTRIKE15", True)
    conf.define("CSTRIKE_REL_BUILD", True)
    conf.define("VPROF_LEVEL", True)
    conf.define("RAD_TELEMETRY_DISABLED", True)
    conf.define("DX_TO_VK_ABSTRACTION", True)
    conf.define("PLATFORM_64BITS", True)

    if build_type == "debug":
        conf.define("DEBUG", 1)
        conf.define("_DEBUG", 1)
    else:
        conf.define("NDEBUG", 1)

    if conf.options.DEDICATED:
        conf.define("DEDICATED", True)

    # --- Dependencies (pkg-config) ---
    conf.check_cfg(package="sdl3", args="--cflags --libs", uselib_store="SDL3")
    includes += conf.env.INCLUDES_SDL3
    conf.check_cfg(package="freetype2", args="--cflags --libs", uselib_store="FREETYPE")
    includes += conf.env.INCLUDES_FREETYPE
    conf.check_cfg(
        package="fontconfig", args="--cflags --libs", uselib_store="FONTCONFIG"
    )
    includes += conf.env.INCLUDES_FONTCONFIG
    conf.check_cfg(package="zlib", args="--cflags --libs", uselib_store="ZLIB")
    conf.check_cfg(package="libjpeg", args="--cflags --libs", uselib_store="JPEG")
    conf.check_cfg(package="libpng", args="--cflags --libs", uselib_store="PNG")

    includes += [
        os.path.abspath("thirdparty/dxvk-native-2.7.1-4bbe487/include/native/windows"),
        os.path.abspath("thirdparty/dxvk-native-2.7.1-4bbe487/include/native/directx"),
    ]

    conf.env.append_unique("INCLUDES", includes)

    # System includes (suppress warnings in thirdparty headers)
    for sysinc in [
        "thirdparty/protobuf-2.6.1/src",
        "thirdparty/DirectXMath-dec2023/Inc",
    ]:
        flag = f"-isystem{os.path.abspath(sysinc)}"
        conf.env.append_unique("CFLAGS", [flag])
        conf.env.append_unique("CXXFLAGS", [flag])

    # Target architecture (override via MARCH env var, default: native)
    march = os.environ.get("MARCH", "native")
    conf.env.append_unique("CFLAGS", [f"-march={march}"])
    conf.env.append_unique("CXXFLAGS", [f"-march={march}"])

    root_env = conf.env
    for prj in PROJECTS:
        conf.setenv(prj, root_env.derive())
        conf.recurse(prj)
    conf.setenv("")


def build(bld):
    base_dir = bld.srcnode.abspath()
    ccache_conf_path = bld.srcnode.make_node("ccache.conf").abspath()
    if os.path.exists(ccache_conf_path):
        os.environ["CCACHE_CONFIGPATH"] = ccache_conf_path
        os.environ["CCACHE_BASEDIR"] = base_dir

    root_env = bld.env

    # --- Shared compilation units (compiled once, linked into many targets) ---
    bld.objects(
        source="public/tier0/memoverride.cpp",
        target="memoverride",
        features="cxx",
        idx=bld.get_taskgen_count(),
    )

    bld.stlib(
        source=[
            "public/filesystem_helpers.cpp",
            "public/vgui_controls/vgui_controls.cpp",
            "public/collisionutils.cpp",
            "public/networkvar.cpp",
            "public/registry.cpp",
            "public/scratchpad3d.cpp",
            "public/dt_utlvector_common.cpp",
            "public/XZip.cpp",
            "public/XUnzip.cpp",
            "common/steamid.cpp",
            "common/platforminputdevice.cpp",
            "common/randoverride.cpp",
        ],
        target="public_common",
        features="cxx",
        idx=bld.get_taskgen_count(),
    )

    for prj in PROJECTS:
        bld.env = bld.all_envs[prj]
        bld.recurse(prj)
    bld.env = root_env
